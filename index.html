<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deriv Trading Client</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body{margin:0;background:#0d0d0d;color:#fff;font-family:Arial, sans-serif}
    #deriv-login{display:flex;justify-content:center;align-items:center;height:200px}
    #deriv-login button{padding:12px 20px;background:#0ff;color:#000;border:none;border-radius:5px;font-size:16px;cursor:pointer}
    #deriv-tool{display:none;padding:20px}
    h1{text-align:center;color:#0ff;margin-bottom:12px}
    .topbar{display:flex;justify-content:space-between;align-items:center;background:#111;padding:8px 12px;font-size:13px}
    .pill{padding:4px 8px;border-radius:999px;background:#0f172a;color:#0ff;border:1px solid #063;font-weight:700}
    .container{display:flex;flex-wrap:wrap;gap:20px}
    .left-panel{flex:3;min-width:300px}
    .right-panel{flex:1;min-width:220px}
    .chart-box,.history{background:#1a1a1a;border-radius:10px;padding:10px;margin-bottom:20px}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border:1px solid #333;padding:5px;text-align:center}
    .win{background:#003300;color:#0f0}
    .loss{background:#330000;color:#f00}
    #crList{position:fixed;right:14px;bottom:14px;background:rgba(10,10,10,.9);border:1px solid #1f2937;border-radius:12px;
      padding:10px 12px;min-width:180px;box-shadow:0 8px 24px rgba(0,0,0,.35);font-size:12px}
    #crList h4{margin:0 0 6px 0;font-size:12px;color:#9ad}
    #crList .tag{display:inline-block;margin:3px 4px 0 0;padding:3px 8px;border-radius:999px;background:#0f172a;
      border:1px solid #0a2;color:#8ff}
  </style>
</head>
<body>
  <div id="deriv-login">
    <button id="loginBtn">Login with Deriv</button>
  </div>

  <div id="deriv-tool">
    <div class="topbar">
      <div>ðŸ§­ Login: <strong id="loginId">-</strong> | Balance: <strong id="balance">-</strong> USD</div>
      <div><span id="adminStatus" class="pill">Admin: idle</span></div>
    </div>

    <h1>ðŸ“Š Deriv Trading Client (Admin Controlled)</h1>

    <div class="container">
      <div class="left-panel">
        <div class="chart-box"><canvas id="priceChart"></canvas></div>
        <div class="chart-box"><canvas id="rsiChart"></canvas></div>
        <div class="history">
          <h3>Trade History</h3>
          <table>
            <thead><tr><th>Time</th><th>Market</th><th>Type</th><th>Entry</th><th>Exit</th><th>Status</th><th>PNL</th></tr></thead>
            <tbody id="tradeHistory"></tbody>
          </table>
        </div>
      </div>

      <div class="right-panel">
        <div class="chart-box">
          <label>Market</label>
          <select id="marketSelect"></select>
          <label>Stake</label>
          <input id="stake" type="number" value="0.35" step="0.01"/>
          <label>Duration</label>
          <select id="duration">
            <option value="5t">5 Ticks</option>
            <option value="10t" selected>10 Ticks</option>
            <option value="30s">30 Seconds</option>
            <option value="1m">1 Minute</option>
          </select>
          <div style="margin-top:6px">Profit: <strong id="profit">0.00</strong> USD</div>
        </div>
      </div>
    </div>
  </div>

  <!-- connected accounts shown -->
  <div id="crList" style="display:none">
    <h4>Connected Accounts</h4>
    <div id="crTags"></div>
  </div>

  <script>
    const APP_ID = '82213';
    const REDIRECT_URI = window.location.href.split('?')[0];
    const OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    const CHANNEL = 'deriv-admin';
    let ws, loginId, currentBalance=0, openTrade=false;

    // OAuth
    (function(){
      const p=new URLSearchParams(location.search);
      if(p.has('token1')&&p.has('acct1')){
        localStorage.setItem('deriv_token',p.get('token1'));
        localStorage.setItem('deriv_loginid',p.get('acct1'));
        history.replaceState(null,'',REDIRECT_URI);
      }
    })();

    const token=localStorage.getItem('deriv_token');
    if(!token){
      document.getElementById('deriv-login').style.display='flex';
      document.getElementById('loginBtn').onclick=()=>location.href=OAUTH_URL;
    } else {
      document.getElementById('deriv-login').style.display='none';
      document.getElementById('deriv-tool').style.display='block';
      start();
    }

    function start(){
      setupWS(); setupAdminChannel();
    }

    function setupWS(){
      ws=new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${APP_ID}`);
      ws.onopen=()=>ws.send(JSON.stringify({authorize:token}));
      ws.onmessage=({data})=>{
        const msg=JSON.parse(data);
        if(msg.authorize){
          loginId=msg.authorize.loginid;
          document.getElementById('loginId').textContent=loginId;
          currentBalance=msg.authorize.balance;
          document.getElementById('balance').textContent=currentBalance.toFixed(2);
          announce();
          setInterval(announce,10000); // heartbeat
        }
        if(msg.buy){
          const c=msg.buy.contract_id;
          const t=new Date().toLocaleTimeString();
          document.getElementById('tradeHistory').insertAdjacentHTML('afterbegin',
            `<tr id="r${c}"><td>${t}</td><td>${msg.echo_req.parameters.symbol}</td><td>${msg.echo_req.parameters.contract_type}</td>
             <td>${msg.echo_req.parameters.amount}</td><td>-</td><td>OPEN</td><td>0</td></tr>`);
          ws.send(JSON.stringify({proposal_open_contract:1,contract_id:c,subscribe:1}));
        }
        if(msg.proposal_open_contract){
          const c=msg.proposal_open_contract;
          const row=document.getElementById(`r${c.contract_id}`); if(!row)return;
          if(c.status==='won'||c.status==='lost'){
            row.className=c.status==='won'?'win':'loss';
            row.cells[5].textContent=c.status.toUpperCase();
            row.cells[6].textContent=c.profit;
            openTrade=false;
          }
        }
      };
    }

    // Admin channel
    function setupAdminChannel(){
      try{const bc=new BroadcastChannel(CHANNEL);bc.onmessage=e=>handleAdmin(e.data);}catch(e){}
      window.addEventListener('storage',e=>{
        if(e.key==='deriv_admin_cmd'&&e.newValue)handleAdmin(JSON.parse(e.newValue));
      });
    }
    function handleAdmin(msg){
      if(msg.cmd==='SET'&&msg.settings)applySettings(msg.settings);
      if(msg.cmd==='TRADE'&&(msg.type==='CALL'||msg.type==='PUT')) doTrade(msg.type);
      if(msg.cmd==='CLIENT_LIST') renderClients(msg.clients||[]);
    }
    function applySettings(s){
      if(s.market)document.getElementById('marketSelect').value=s.market;
      if(s.stake)document.getElementById('stake').value=s.stake;
      if(s.duration)document.getElementById('duration').value=s.duration;
    }
    function doTrade(type){
      if(openTrade)return;
      const stake=document.getElementById('stake').value;
      const durVal=document.getElementById('duration').value;
      const dur=parseInt(durVal); const unit=durVal.includes('t')?'t':durVal.includes('s')?'s':'m';
      const sym=document.getElementById('marketSelect').value;
      ws.send(JSON.stringify({buy:1,price:stake,
        parameters:{amount:stake,basis:'stake',contract_type:type,currency:'USD',duration:dur,duration_unit:unit,symbol:sym}
      }));
      openTrade=true;
    }

    // announce to backend
    function announce(){
      post({cmd:'HEARTBEAT',loginId});
    }
    function post(payload){
      try{const bc=new BroadcastChannel(CHANNEL);bc.postMessage(payload);}catch(e){}
      localStorage.setItem('deriv_admin_cmd',JSON.stringify(payload));
    }

    // show connected accounts
    function renderClients(list){
      const box=document.getElementById('crList'); const tags=document.getElementById('crTags');
      tags.innerHTML=''; (list||[]).forEach(id=>{const s=document.createElement('span');s.className='tag';s.textContent=id;tags.appendChild(s);});
      box.style.display=list.length?'block':'none';
    }

    // markets
    ['R_10','R_25','R_50','R_75','R_100','R_10_1s','R_25_1s'].forEach(m=>{
      document.getElementById('marketSelect').append(new Option(m,m));
    });
  </script>
</body>
</html>
